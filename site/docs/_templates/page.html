{%- extends "layout.html" %}

{% block content %}
<div class="container-fluid documentations main-content" role="main">
    <div class="row">
        <div class="col-md-2">
            <div class="doc-nav-wrapper">
                <div class="info-bar">
                    <select class="form-control" id="productDocumentationSelector"
                        name="product-documentation-selector">
                        <option value="dxp">
                            {% trans %}DXP{% endtrans %}
                        </option>
                        <option value="dxp-cloud">
                            {% trans %}DXP Cloud{% endtrans %}
                        </option>
                        <option value="commerce">
                            {% trans %}Commerce{% endtrans %}
                        </option>
                    </select>
                </div>

                <div class="doc-nav">
                    <a class="back-link btn btn-monospaced btn-link" href="javascript:;" id="backLink">
                        <svg class="lexicon-icon lexicon-icon-angle-left" role="presentation" viewBox="0 0 512 512">
                            <use xlink:href="#angle-left" />
                        </svg>
                        {% trans %}Go Back{% endtrans %}
                    </a>

                    {% block sidebar1 %}
                    {{ toctree(titles_only=True) }}
                    {% endblock %}
                </div>
            </div>
        </div>

        <div class="col-md-10 doc-body">
            <div class="col-md-12 general-info info-bar">
                <div class="breadcrumb-wrapper col-md-7 offset-md-1">
                    {% include "breadcrumb.html" %}
                </div>

                <div class="actions col-md-2 offset-md-1">
                    <a href="https://github.com/liferay/liferay-learn">
                        <svg>
                            <use xlink:href="#edit"></use>
                        </svg>
                    </a>
                </div>
            </div>

            <div class="col-md-12 doc-content row">
                <div class="col-md-7 article-body offset-md-1">
                    {% block document %}
                    {{ body }}
                    {% endblock %}
                </div>

                <div class="col-md-2 offset-md-1">
                    <ul class="nav nav-stacked toc" id="articleTOC"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Table of contents reading indicator

    const headings = document.querySelectorAll('.article-body h2');

    let activeIndex;
    let targets = [];

    if (headings) {
        const articleTOC = document.getElementById('articleTOC');

        headings.forEach(
            heading => {
                const id = heading.querySelector('a').hash.replace('#', '');

                if (articleTOC) {
                    articleTOC.innerHTML += `
                    <li class="nav-item">
                        <a class="nav-link" id="toc-${id}" href="#${id}">
                            ${heading.innerText}
                        </a>
                    </li>`;
                }

                targets.push({ id: id, isIntersecting: false });
            }
        );
    }

    const callback = entries => {
        entries.forEach(entry => {
            const index = targets.findIndex(target => target.id === entry.target.id);

            targets[index].isIntersecting = entry.isIntersecting;

            if (!targets[activeIndex] || !targets[activeIndex].isIntersecting) {
                setActiveIndex()
            }
        });

        if (targets[activeIndex]) {
            toggleActiveClass(targets[activeIndex].id);
        }
    };

    // rootMargin of 157px is header height + info bar height + 24px gutter offset

    const observer = new IntersectionObserver(callback, { rootMargin: '-157px', threshold: [0, 0.2, 0.4, 0.6, 0.8, 1] });

    const setActiveIndex = () => {
        activeIndex = targets.findIndex(target => target.isIntersecting === true);
    };

    const toggleActiveClass = id => {
        targets.forEach(target => {
            const node = document.getElementById(`toc-${target.id}`);

            if (node) {
                node.classList.remove('active');
            }
        });

        const activeNode = document.getElementById(`toc-${id}`);

        if (activeNode) {
            activeNode.classList.add('active');
        }
    }

    targets.forEach(target => {
        const node = target.id ? document.getElementById(target.id) : null;

        if (node) {
            observer.observe(node);

            node.style.cssText = "margin-top: -157px; padding-top: 157px;"
        }
    });

    // Documentation dropdown

    const breadcrumbAncestor = document.querySelector('.breadcrumb-parent');
    const breadcrumbCurrentArticle = document.getElementById('breadcrumbCurrentArticle');

    const productDocumentationSelector = document.getElementById('productDocumentationSelector');

    if (breadcrumbCurrentArticle && productDocumentationSelector) {

        // Preselect documentation dropdown to be the current article's product

        const currentDocProduct = breadcrumbAncestor ? breadcrumbAncestor : breadcrumbCurrentArticle;

        const currentDocProductValue = currentDocProduct.innerText.replace(/\s/g, '-').toLowerCase();

        productDocumentationSelector.value = currentDocProductValue;

        // Route user to the selected documentation landing page

        productDocumentationSelector.addEventListener('click', event => {
            const target = event.target.value;

            if (target !== currentDocProductValue) {
                if (target === 'commerce') {
                    window.location.pathname = '/commerce-2.x/index.html';
                } else if (target === 'dxp-cloud') {
                    window.location.pathname = '/dxp-cloud-latest/index.html';
                } else {
                    window.location.pathname = '/dxp-7.2.x/index.html';
                }
            }
        });
    }

    // Left nav interaction

    const activeNavL1 = document.querySelector('.toctree-l1.current');
    const backLink = document.getElementById('backLink');

    let backURL = null;

    if (activeNavL1 && backLink) {
        // Zoom in on the current section

        const nonActiveNavL1 = document.querySelectorAll('.toctree-l1:not(.current)');

        nonActiveNavL1.forEach(node => node.classList.add('d-none'));

        // Set back URL

        backURL = breadcrumbAncestor ? breadcrumbAncestor.href : '';

        let activeNavL2 = null;
        const activeNavL2List = activeNavL1.querySelectorAll('li.toctree-l2');

        activeNavL2List.forEach(node => {
            if (node.classList.contains('current')) {
                activeNavL2 = node;
            }
        });

        if (activeNavL2) {

            // Set back URL

            const breadcrumbParents = document.querySelectorAll('.breadcrumb-parent');

            backURL = breadcrumbParents[breadcrumbParents.length - 1].href;

            let activeNavL3 = null;
            const activeNavL3List = activeNavL2.querySelectorAll('li.toctree-l3');

            if (activeNavL3List.length) {
                activeNavL3List.forEach(node => {
                    if (node.classList.contains('current')) {
                        activeNavL3 = node;
                    }
                });

                // Zoom in on the current selection 

                activeNavL1.querySelector('a').classList.add('d-none');

                const nonActiveNavL2 = activeNavL1.querySelectorAll('.toctree-l2:not(.current)');

                nonActiveNavL2.forEach(node => node.classList.add('d-none'));

                activeNavL2.classList.add('top-level');

                // Set back URL

                backURL = breadcrumbParents[breadcrumbParents.length - 2].href;
            }
        }

        backLink.href = backURL;
    } else {
        if (backLink) {
            backLink.classList.add('d-none');
        }
    }
</script>
{% endblock %}